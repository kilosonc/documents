我们是来自网易云音乐的云原生团队。我们平常的工作是运维一个基于 GitOps 的 CICD 平台—— Horizon。Horizon 中，有许多的管控组件，这些管控组件的运维也是有很多问题。我们需要解决，尽量减少运维出错，出错后能够快速恢复，大量组件运维要求我们，能够多人协作，提高自动化水平等等。

## 管控面运维

为了解决以上提到的问题，云原生团队内部管控组件部署，实现了一套基于 Gitlab CI 的 GitOps 部署规范流程。云原生团队内部，每个线上运行的组件都有一个对应的代码仓库和部署仓库。开发者将修改推到代码仓库后，通过review合入主分支，打出对应的镜像。只需要修改 GitOps 部署仓库，就能将修改部署到线上。

1. 首先开发者需要 Fork 一份部署仓库的代码，部署仓库一般为一个 [Helm](https://helm.sh/) Chart。该仓库中只需改动values.yaml 文件，一般情况下，修改该文件即可满足开发者的需求。而 templates 文件则打包放在 Harbor 中。配置仓库通过的 Chart.yaml 的 dependency 字段引用该 templates。因为我们有多个环境需要部署相同的组件。将 templates 抽出来，可以将统一的配置放于 templates 中，而各自的配置仓库中，可以放不同的配置。兼顾统一与灵活。  

2. 开发者在修改配置仓库后，需要将修改推到仓库中，并向 master 分支提交 MR。这时会触发流水线，验证修改是否正确。

3. 通过验证后，开发者需要请求团队中的其他人帮忙 review，通过检查后，合入主分支。

4. 合入主分支，会触发另一条流水线，将修改应用到 Kubernetes 中。

5. 开发者如果观察到本次修改存在任何问题，并且无法快速恢复，那么可以找到上一次成功的发布，重新跑一下对应的流水线，就可以快速回滚。

![[Pasted image 20230606193220.jpg]]

通过以上流程，我们通过引入测试流水线和 Reviewer 降低了出错的概率，通过重新运行部署流水线完成了